<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<dom-module id="uva-buildings">
  <template>
    <iron-ajax auto url="[[_buildingsURL]]" handle-as="json" last-response="{{_buildings}}">
    <app-indexeddb-mirror key="[[_buildingsURL]]" data="[[_asArray(_buildings)]]" persisted-data="{{_persistedBuildings}}"></app-indexeddb-mirror>
    <iron-ajax auto url="[[_categoriesURL]]" handle-as="json" last-response="{{_categories}}">
    <app-indexeddb-mirror key="[[_categoriesURL]]" data="[[_categories]]" persisted-data="{{categories}}"></app-indexeddb-mirror>
  </template>
  <script>
    /**
     * `uva-buildings`
     * Helper component to bind to the UVA buildings API.
     * This API provides information about many buildings on campus. It can be used to get building information such as Name, Category, Address, Square Footage, Year Built, and GPS coordinates of every place on campus.
     *
     * All buildings are available via the `buildings` attribute and can be filtered via the `category` attribute.  All of the valid categories to filter by are available via the `catagories` attribute.
     *
     * Example:
     *
     *    <uva-buildings buildings="{{buildings}}" category="{{category}}" categories="{{categories}}"></uva-buildings>
     *
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvaBuildings extends Polymer.Element {
      static get is() { return 'uva-buildings'; }
      static get properties() {
        return {
          _buildings: {
            type: Array,
            value: function(){return [];}
          },
          _persistedBuildings: {
            type: Array,
            value: function(){return [];},
            observer: "_filterBuildings"
          },
          buildings: {
            type: Array,
            value: function(){return [];},
            notify: true
          },
          building: {
            type: Object,
            computed: "_firstBuilding(buildings)",
            notify: true
          },
          name: {
            type: String
          },
          id: {
            type: String
          },
          _categories: {
            type: Array,
            value: function(){return [];},
          },
          categories: {
            type: Array,
            value: function(){return [];},
            notify: true
          },
          category: {
            type: String,
            observer: "_filterBuildings"
          },

          minSquareFootage: {
            type: Number,
            observer: "_filterBuildings"
          },
          maxSquareFootage: {
            type: Number,
            observer: "_filterBuildings"
          },
          minYearBuilt: {
            type: Number,
            observer: "_filterBuildings"
          },
          maxYearBuilt: {
            type: Number,
            observer: "_filterBuildings"
          },
          historic: {
            type: Boolean,
            observer: "_filterBuildings"
          },
          latitude: {
            type: Number,
            observer: "_filterBuildings"
          },
          longitude: {
            type: Number,
            observer: "_filterBuildings"
          },
          distance: {
            type: Number,
            observer: "_filterBuildings"
          },

          _buildingsURL: {
            type: String,
            computed: "_makeBuildingsURL(name, id, _buildings)",
            notify: true
          },
          _categoriesURL: {
            type: String,
            value: "https://api.library.virginia.edu/devhub/categories",
            notify: true
          }
        };
      }
      ready() {
        super.ready();
      }
      _asArray(obj){
        return (Array.isArray(obj))?
          obj:
          new Array(obj);
      }
      _filterBuildings(whichFilter) {
        // A bit crude, but it get err done
        var buildings = this._persistedBuildings;
        if (this.category) buildings = buildings.filter((bl) => bl.Category.toLowerCase() == this.category.toLowerCase() );
        if (this.minSquareFootage) buildings = buildings.filter((bl) => bl.SquareFootage >= this.minSquareFootage );
        if (this.maxSquareFootage) buildings = buildings.filter((bl) => bl.SquareFootage <= this.maxSquareFootage );
        if (this.minYearBuilt) buildings = buildings.filter((bl) => bl.YearBuilt >= this.minYearBuilt );
        if (this.maxYearBuilt) buildings = buildings.filter((bl) => bl.YearBuilt <= this.maxYearBuilt );
        if (this.historic) buildings = buildings.filter((bl) => bl.Historic );
        if (this.latitude && this.longitude) {
          // add a distance property to the buildings
          buildings.forEach(function(bl){
            if (bl.Latitude && bl.Longitude) {
              bl.distance = this._distance(bl.Latitude,bl.Longitude,this.latitude,this.longitude);
            }
            if (this.distance) buildings = buildings.filter((b) => b.distance && b.distance <= this.distance);
          });
        }
        this.set('buildings', buildings);
        console.log('set buildings');
      }
      _distance(lat1, lon1, lat2, lon2) {
        var p = 0.017453292519943295;    // Math.PI / 180
        var c = Math.cos;
        var a = 0.5 - c((lat2 - lat1) * p)/2 +
                c(lat1 * p) * c(lat2 * p) *
                (1 - c((lon2 - lon1) * p))/2;

        return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
      }
      _makeBuildingsURL(name, id, category) {
        console.log('burl');
        var url = "https://api.library.virginia.edu/devhub/";
        if (id) {
          url += "buildingId/"+id;
        } else if (name) {
          url += "buildings/"+name;
        } else {
          url += "buildings";
        }
        console.log(url);
        return url;
      }
      _firstBuilding() {
        return (this.buildings && this.buildings.length > 0)?
          this.buildings[0]:
          null;
      }
    }

    window.customElements.define(UvaBuildings.is, UvaBuildings);
  </script>
</dom-module>
