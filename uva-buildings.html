<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<dom-module id="uva-buildings">
  <template>
    <iron-ajax auto url="[[_buildingsURL]]" handle-as="json" last-response="{{_buildings}}">
    <app-indexeddb-mirror key="[[_buildingsURL]]" data="[[_asArray(_buildings)]]" persisted-data="{{buildings}}"></app-indexeddb-mirror>
    <iron-ajax auto url="[[_categoriesURL]]" handle-as="json" last-response="{{_categories}}">
    <app-indexeddb-mirror key="[[_categoriesURL]]" data="[[_categories]]" persisted-data="{{categories}}"></app-indexeddb-mirror>
  </template>
  <script>
    /**
     * `uva-buildings`
     * Helper component to bind to the UVA buildings API.
     * This API provides information about many buildings on campus. It can be used to get building information such as Name, Category, Address, Square Footage, Year Built, and GPS coordinates of every place on campus.
     *
     * All buildings are available via the `buildings` attribute and can be filtered via the `category` attribute.  All of the valid categories to filter by are available via the `catagories` attribute.
     *
     * Example:
     *
     *    <uva-buildings buildings="{{buildings}}" category="{{category}}" categories="{{categories}}"></uva-buildings>
     *
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvaBuildings extends Polymer.Element {
      static get is() { return 'uva-buildings'; }
      static get properties() {
        return {
          _buildings: {
            type: Array,
            value: function(){return [];},
          },
          buildings: {
            type: Array,
            value: function(){return [];},
            notify: true
          },
          building: {
            type: Object,
            computed: "_firstBuilding(buildings)",
            notify: true
          },
          name: {
            type: String
          },
          id: {
            type: String
          },
          _categories: {
            type: Array,
            value: function(){return [];},
          },
          categories: {
            type: Array,
            value: function(){return [];},
            notify: true
          },
          category: {
            type: String
          },
          _buildingsURL: {
            type: String,
            computed: "_makeBuildingsURL(name, id, category, _buildings)",
            notify: true
          },
          _categoriesURL: {
            type: String,
            value: "https://api.library.virginia.edu/devhub/categories",
            notify: true
          }
        };
      }
      ready() {
        super.ready();
      }
      _asArray(obj){
        return (Array.isArray(obj))?
          obj:
          new Array(obj);
      }
      _makeBuildingsURL(name, id, category) {
        console.log('burl');
        var url = "https://api.library.virginia.edu/devhub/";
        if (id) {
          url += "buildingId/"+id;
        } else if (name) {
          url += "buildings/"+name;
        } else if (category) {
          url += "categories/"+category;
        } else {
          url += "buildings";
        }
        console.log(url);
        return url;
      }
      _firstBuilding() {
        return (this.buildings && this.buildings.length > 0)?
          this.buildings[0]:
          null;
      }
    }

    window.customElements.define(UvaBuildings.is, UvaBuildings);
  </script>
</dom-module>
